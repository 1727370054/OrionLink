# 注册中心高可用
> CAP 是指在一个分布式系统下，包含三个要素：Consistency（一致性）、Availability（可用性）、Partition tolerance（分区容错性），并且三者不可得兼。 


    一致性（Consistency），是指对于每一次读操作，要么都能够读到最新写入的数据，要么错误，所有数据变动都是同步的。 
    可用性（Availability），是指对于每一次请求，都能够得到一个及时的、非错的响应，但是不保证请求的结果是基于最新写入的数据。即在可以接受的时间范围内正确地响应用户请求。 
    分区容错性（Partition tolerance），是指由于节点之间的网络问题，即使一些消息丢包或者延迟，整个系统仍能够提供满足一致性和可用性的服务。   关系型数据库单节点保证了数据强一致性（C）和可用性（A），但是却无法保证分区容错性（P）。 

    然而在分布式系统下，为了保证模块的分区容错性（P），只能在数据强一致性（C）和可用性（A）之间做平衡。具体表现为在一定时间内，可能模块之间数据是不一致的，但是通过自动或手动补偿后能够达到最终的一致。

    可用性一般是更好的选择，但是在服务和数据库之间维护事务一致性是非常根本的需求，微服务架构中应该选择满足最终一致性。
# 可用性重构说明 （CA）不做P
    - 设定读超时，客户端定期发送心跳，超时后认为断开（ 不保证容错了）
        添加心跳消息，设定超时时间，客户端定期发送
    - 客户端内存中存储微服务列表（注册中心断开时使用）
    - 客户端磁盘中存储微服务列表（注册中心断开时使用）
        接收到服务列表消息时存储，需要区分获取全部微服务还是一种微服务，全部微服务覆盖，单个只覆盖此类微服务
        1 添加一种微服务列表获取的消息
        2 存储到本地缓存的命名规则 按照"register_"<<service_name_<<service_ip_<<service_port_<<".cache"
        3 确认读取缓存的条件：第一次连接注册中心不成功
        

## 注册中心后启动的处理
    - 如果微服务启动时 注册中心未启动，则等启动成功后再注册（不注册不影响业务功能使用，因为其他微服务也有缓存）
    - 如果注册中心重启后，微服务需要重新注册


# 注册中心部署说明
    - 由于注册中心没有做持久化，所以不能保证一致性，注册中心暂时不做集群，并且要保持注册中心轻负载
# 注册中的安装
    - make install 自动生成start和stop脚本
    - watchdog 守护进程自动重启进程
    


# 注册中心客户端的心跳
    - 心跳三秒收不到，异常
    - 服务端设定读超时 5秒
    - 客户端定时发送心跳 3秒
    - 心跳包，空包 msg = heart

