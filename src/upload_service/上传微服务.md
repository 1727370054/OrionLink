# 上传微服务
## 支持秒传
    秒传另外创建一个微服务，需要连接数据库 可以作为学员作业

## 通过网关获取可用微服务的IP和端口
- 权限的考虑，其他微服务本身都部署在内网，内外网隔离无法访问
- 获取微服务的地址，本身指令也有权限，后面添加权限
## 断点续传
- 每个文件以1M为单位切割位文件片 （配置中心配置）
- 每个文件片有独立的md5 校验
- 上传在本地先做切割
## 文件的MD5
- 分片（1M每片）生成md5
- 每片的md5 再做md5 作为文件md5
## 上传文件指令
### 创建文件
    首先提交创建文件指令，提交后生成文件，如果以前有此文件则清空
    客户端每个文件使用不同的proxy对象，不同的线程处理
- 文件名
- 文件修改时间
- 文件大小
- 文件MD5 校验
    //序列化到文件 文件名.pb
    message XUploadFile
    {
        string filename = 1;
        int64 write_time = 2;
        int64 filesize = 3;
        bytes md5 = 4; //一开始不上传，在文件全部传完后写入，在序列化到文件
    }

### 续传文件片
- 支持多文件同时续传
- 每个文件使用不同的线程
- 文件上传都用此指令，包括小于1m的文件
- 接收文件并缓存到内存，接收完毕验证文件片MD5，错误，删除此文件缓存，通知客户端重传
- 验证成功，通知客户端成功

### 文件上传完成
    服务端接收到指令，写入全部缓存，验证文件md5，如果错误则删除文件，关闭文件，写入XUploadFile文件信息文件
- 文件名
- 文件md5

# 上传流程

    客户端                 服务端
    1发送上传文件指令 ==》  
                        《== 2确认可以接收文件（验证权限和空间大小）
    3发送文件片 （要等待上次的发送结果，失败需要重发）==》
                        《== 4文件片接收成功或者失败（验证接收文件片大小和校验，失败返回原因）
    5文件发送完成==》                                                 
                        《== 6文件接收成功或者失败（写入缓存中所有内容，验证文件接收总大小和md5，失败返回原因）